<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuMatch Inmobiliario - Propiedades Premium</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        button, select, input, textarea {
            touch-action: manipulation;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #030508;
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Fondo profesional con gradientes sutiles */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #030508 0%, #0a0a15 30%, #050812 70%, #020406 100%);
            z-index: -2;
        }
        
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 25% 85%, rgba(90, 120, 180, 0.04) 0%, transparent 60%),
                radial-gradient(ellipse at 75% 15%, rgba(180, 90, 140, 0.03) 0%, transparent 55%);
            z-index: -1;
            animation: subtleFlow 60s linear infinite;
        }
        
        @keyframes subtleFlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Layout principal */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header redise√±ado */
        .main-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 32px;
            padding: 40px 60px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 20px 80px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .brand-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF1493 50%, #8A2BE2 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2);
        }

        .brand-text h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #FF6B6B, #FF1493, #8A2BE2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .brand-text p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        /* Indicador UF redise√±ado */
        .uf-display {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.05) 100%);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 24px;
            padding: 24px 32px;
            text-align: center;
            min-width: 200px;
            box-shadow: 0 12px 48px rgba(255, 215, 0, 0.1);
        }

        .uf-label {
            font-size: 0.9rem;
            color: rgba(255, 215, 0, 0.8);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .uf-value {
            font-size: 1.4rem;
            color: #FFD700;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .uf-date {
            font-size: 0.75rem;
            color: rgba(255, 215, 0, 0.6);
        }

        /* Navegaci√≥n de acciones */
        .action-nav {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 40px;
        }

        .action-btn {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.8), rgba(123, 97, 255, 0.8));
            border: none;
            border-radius: 20px;
            padding: 16px 32px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(255, 107, 107, 0.3);
            background: linear-gradient(135deg, rgba(255, 107, 107, 1), rgba(123, 97, 255, 1));
        }

        /* Sistema de filtros moderno */
        .filters-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 32px;
            padding: 48px;
            margin-bottom: 48px;
            box-shadow: 
                0 24px 96px rgba(0, 0, 0, 0.2),
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
        }

        .filters-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .filters-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #FF6B6B, #FF1493);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .filters-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .filter-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.03) 100%);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 32px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        .filter-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 107, 107, 0.2);
        }

        .filter-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-icon {
            font-size: 1.2rem;
        }

        .filter-input, .filter-select {
            width: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 16px 20px;
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            transition: border-color 0.2s ease, background 0.2s ease;
            outline: none;
        }

        .filter-input:focus, .filter-select:focus {
            border-color: rgba(255, 107, 107, 0.5);
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.1);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.3) 100%);
        }

        .filter-select option {
            background: #1a1a2e;
            color: white;
            padding: 12px;
        }

        /* Toggle switches modernos */
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
        }

        .toggle-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 8px 16px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.8), rgba(123, 97, 255, 0.8));
            color: white;
            border-color: rgba(255, 107, 107, 0.3);
        }

        /* Sistema de tarjetas premium */
        .properties-section {
            margin-bottom: 60px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
        }

        .properties-count {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(123, 97, 255, 0.2));
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 16px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
            padding: 20px 0;
        }

        .property-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 28px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            position: relative;
            animation: fadeInUp 0.4s ease forwards;
            opacity: 0;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
            display: flex;
            flex-direction: column;
            height: 100%;
            will-change: transform;
        }

        .property-card:hover {
            transform: translateY(-6px);
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.25),
                0 1px 0 rgba(255, 255, 255, 0.2) inset;
            border-color: rgba(255, 107, 107, 0.3);
        }

        .card-header {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF1493 50%, #8A2BE2 100%);
            padding: 28px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .property-code {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            line-height: 1.2;
            z-index: 15;
            pointer-events: auto;
            max-width: 100px;
        }

        .property-code:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.05);
        }

        .property-price {
            font-size: 2.8rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .property-price:hover {
            transform: scale(1.05);
        }

        .price-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .card-content {
            padding: 28px;
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 16px;
        }

        .property-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }

        .bono-badge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
            color: #1a1a2e;
            padding: 24px 28px;
            border-radius: 18px;
            font-weight: 900;
            font-size: 1.6rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
            border: 2px solid rgba(255, 215, 0, 0.6);
            flex-shrink: 0;
        }

        .rentabilidad-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            flex-shrink: 0;
        }

        .card-actions {
            display: flex;
            gap: 12px;
            margin-top: auto;
            flex-shrink: 0;
        }

        .btn-primary {
            flex: 1;
            background: linear-gradient(135deg, #FF6B6B, #FF1493);
            border: none;
            border-radius: 16px;
            padding: 18px 24px;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);
            text-align: center;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 107, 0.4);
        }

        /* Modal moderno */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 32px;
            padding: 40px;
            max-width: 800px;
            max-height: 90vh;
            width: 100%;
            overflow-y: auto;
            position: relative;
            box-shadow: 
                0 32px 128px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.2) inset;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 107, 107, 0.8);
            transform: scale(1.1);
        }

        /* Estados de carga y vac√≠o */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 107, 107, 0.3);
            border-top: 4px solid #FF6B6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Large screens */
        @media (min-width: 1920px) {
            .app-container {
                max-width: 1600px;
            }
            
            .properties-grid {
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            }
        }
        
        /* Responsive design - Tablets */
        @media (max-width: 1024px) {
            .properties-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
            
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                margin: 40px;
            }
        }
        
        /* Mobile landscape and tablets portrait */
        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                gap: 24px;
                text-align: center;
                padding: 24px 16px;
            }
            
            .action-nav {
                flex-direction: column;
                gap: 12px;
                padding: 0 16px;
            }
            
            .action-btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 0.95rem;
            }
            
            .toggle-favorites-btn, .toggle-compare-btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 0.95rem;
                justify-content: center;
            }

            .brand-text h1 {
                font-size: 2.2rem;
            }

            .filters-section {
                padding: 32px 20px;
                border-radius: 24px;
                margin: 0 16px 32px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
                padding: 0 16px;
            }
            
            .section-header > div {
                width: 100%;
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            .sort-container {
                width: 100%;
            }
            
            #sortProperties {
                width: 100% !important;
                min-width: unset !important;
            }

            .properties-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 0 16px;
            }

            .property-card {
                border-radius: 24px;
            }

            .card-header {
                padding: 24px;
            }

            .property-price {
                font-size: 2.2rem;
            }

            .modal-content {
                padding: 24px;
                margin: 16px;
                border-radius: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-body {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .bono-badge {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
            
            /* Reposicionar botones solo en m√≥vil */
            .favorite-btn {
                top: 8px !important;
                right: 8px !important;
                left: auto !important;
            }
            
            .compare-btn {
                right: 48px !important;
            }
            
            .property-code {
                top: 8px !important;
                left: 8px !important;
                right: auto !important;
                max-width: none !important;
                font-size: 0.7rem !important;
                padding: 4px 8px !important;
                display: flex !important;
                align-items: center !important;
                gap: 6px !important;
            }
            
            .property-code > div {
                display: inline !important;
                margin: 0 !important;
            }
            
            .property-code > div:first-child {
                font-size: 0.6rem !important;
                opacity: 0.7 !important;
            }
            
            .property-code > div:nth-child(2) {
                font-weight: 700 !important;
            }
            
            .property-code > div:last-child {
                display: none !important;
            }
            
            .card-header {
                padding-top: 48px !important;
            }
        }

        /* Mobile devices */
        @media (max-width: 480px) {
            .brand-text h1 {
                font-size: 1.6rem;
            }
            
            .brand-text p {
                font-size: 0.9rem;
            }
            
            .uf-display {
                padding: 16px 20px;
                min-width: 160px;
            }
            
            .uf-value {
                font-size: 1.1rem;
            }

            .filters-section {
                padding: 24px 16px;
                margin: 0 12px 24px;
            }
            
            .filters-title {
                font-size: 1.5rem;
            }
            
            .filters-subtitle {
                font-size: 0.9rem;
            }

            .filter-card {
                padding: 20px;
            }
            
            .filter-label {
                font-size: 0.95rem;
            }
            
            .filter-toggle button {
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            .property-price {
                font-size: 1.5rem;
            }
            
            .property-card {
                border-radius: 20px;
            }
            
            .card-header {
                padding: 20px;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .cap-rate-badge {
                padding: 10px 16px;
            }
            
            .properties-count {
                font-size: 0.9rem;
                padding: 10px 16px;
            }
            
            .empty-icon {
                font-size: 4rem;
            }
            
            .compare-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .compare-table table {
                min-width: 600px;
            }
            
            .favorites-section, .compare-section {
                padding: 24px 16px;
                border-radius: 20px;
                margin: 0 16px 24px;
            }
            
            .modal-content h2 {
                font-size: 1.5rem;
            }
            
            .modal-close {
                top: 16px;
                right: 16px;
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
        }

        /* Sistema de Favoritos */
        /* Small mobile devices */
        @media (max-width: 360px) {
            .brand-text h1 {
                font-size: 1.4rem;
            }
            
            .property-price {
                font-size: 1.3rem;
            }
            
            .filters-section {
                padding: 20px 12px;
            }
        }
        
        .favorites-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08) 0%, rgba(255, 165, 0, 0.04) 100%);
            backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 32px;
            padding: 40px;
            margin-bottom: 40px;
            display: none;
        }
        
        .favorites-section.active {
            display: block;
        }
        
        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .favorites-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #FFD700;
        }
        
        .favorites-count {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .favorite-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            font-size: 1rem;
        }
        
        .favorite-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.3);
        }
        
        .favorite-btn.active {
            background: rgba(255, 215, 0, 0.9);
            border-color: #FFD700;
        }
        
        .favorite-btn.active:hover {
            transform: scale(0.95);
        }
        
        .toggle-favorites-btn {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
            color: #1a1a2e;
            border: none;
            border-radius: 20px;
            padding: 16px 32px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
            white-space: nowrap;
        }
        
        .toggle-favorites-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 48px rgba(255, 215, 0, 0.4);
        }
        
        /* Sistema de Comparador */
        .compare-section {
            background: linear-gradient(135deg, rgba(75, 85, 255, 0.08) 0%, rgba(138, 43, 226, 0.04) 100%);
            backdrop-filter: blur(50px);
            border: 1px solid rgba(138, 43, 226, 0.15);
            border-radius: 32px;
            padding: 40px;
            margin-bottom: 40px;
            display: none;
        }
        
        .compare-section.active {
            display: block;
        }
        
        .compare-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .compare-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8A2BE2;
        }
        
        .compare-count {
            background: rgba(138, 43, 226, 0.2);
            color: #8A2BE2;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .compare-btn {
            position: absolute;
            top: 8px;
            right: 130px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            font-size: 1rem;
            border: none;
        }
        
        .compare-btn:hover {
            transform: scale(1.1);
            background: rgba(138, 43, 226, 0.3);
        }
        
        .compare-btn.active {
            background: rgba(138, 43, 226, 0.9);
            border-color: #8A2BE2;
        }
        
        .compare-btn.active:hover {
            transform: scale(0.95);
        }
        
        .toggle-compare-btn {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 85, 255, 0.9));
            color: white;
            border: none;
            border-radius: 20px;
            padding: 16px 32px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(138, 43, 226, 0.3);
            white-space: nowrap;
        }
        
        .toggle-compare-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 48px rgba(138, 43, 226, 0.4);
        }
        
        .compare-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 20px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            margin-bottom: 30px;
        }
        
        .compare-table th {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(75, 85, 255, 0.8));
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .compare-table td {
            padding: 16px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .best-value {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2)) !important;
            border: 1px solid rgba(34, 197, 94, 0.5) !important;
            font-weight: 700 !important;
        }
        
        .best-value::before {
            content: '‚úì';
            position: absolute;
            top: 4px;
            right: 4px;
            color: #22c55e;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .compare-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .compare-table .row-label {
            background: rgba(138, 43, 226, 0.1);
            font-weight: 600;
            text-align: left;
            color: #8A2BE2;
        }

        /* Estilos para herramientas de favoritos */
        .favorites-tools {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 85, 255, 0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .tools-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tools-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(75, 85, 255, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-btn:hover {
            background: linear-gradient(135deg, rgba(138, 43, 226, 1), rgba(75, 85, 255, 1));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.4);
        }

        .stats-panel {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .stat-value {
            font-weight: 600;
            color: #8A2BE2;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .stat-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .remove-compare {
            background: rgba(255, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .remove-compare:hover {
            background: rgba(255, 68, 68, 1);
            transform: scale(1.05);
        }
        
        .compare-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 30px;
        }
        
        .compare-action-btn {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(75, 85, 255, 0.8));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .compare-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(138, 43, 226, 0.4);
        }
        
        .highlight-differences {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(255, 152, 0, 0.8)) !important;
            color: #1a1a2e !important;
        }
        
        .difference-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ffc107;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        /* Bot√≥n flotante de volver arriba */
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #FF6B6B, #FF1493);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.4);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .scroll-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(255, 107, 107, 0.5);
            background: linear-gradient(135deg, #FF1493, #8A2BE2);
        }
        
        .scroll-to-top svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Utilidades */
        .text-center { text-align: center; }
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-4 { gap: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header principal -->
        <header class="main-header" style="animation: fadeInDown 0.8s ease;">
            <div class="header-content">
                <div class="brand-section">
                    <div class="brand-icon">üè†</div>
                    <div class="brand-text">
                        <h1>TUMATCH</h1>
                        <p>Inmobiliario Premium</p>
                    </div>
                </div>
                <div class="uf-display">
                    <div class="uf-label">Valor UF Hoy</div>
                    <div class="uf-value" id="uf-value">Cargando...</div>
                    <div class="uf-date" id="uf-date"></div>
                </div>
            </div>
        </header>

        <!-- Navegaci√≥n de acciones -->
        <nav class="action-nav">
            <button id="condicionesBtn" class="action-btn" onclick="showCondicionesModal()">
                üìã T√©rminos y Condiciones
            </button>
            <button id="toggleFavoritesBtn" class="toggle-favorites-btn" onclick="toggleFavorites()">
                ‚≠ê Mis Favoritos (<span id="favoritesCount">0</span>)
            </button>
            <button id="toggleCompareBtn" class="toggle-compare-btn" onclick="toggleCompare()">
                üîÑ Comparar (<span id="compareCount">0</span>)
            </button>
        </nav>

        <!-- Indicador de carga -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h3>Cargando propiedades premium...</h3>
            <p>Preparando la mejor selecci√≥n para ti</p>
        </div>

        <!-- Contenido principal -->
        <main id="content" class="hidden">
            <!-- Secci√≥n de filtros -->
            <section class="filters-section">
                <div class="filters-header">
                    <h2 class="filters-title">üîç Filtros Inteligentes</h2>
                    <p class="filters-subtitle">Encuentra tu propiedad ideal con nuestro sistema avanzado de b√∫squeda</p>
                </div>

                <div class="filters-grid">
                    <div class="filter-card">
                        <label class="filter-label">
                            <span class="filter-icon">üí∞</span>
                            Rango de Bono
                            <div class="filter-toggle">
                                <button id="toggleBonoFilter" class="toggle-btn active" onclick="toggleBonoFilterType()">
                                    üìä Rangos Din√°micos
                                </button>
                            </div>
                        </label>
                        <div id="bonoRangeFilter">
                            <select id="filterBono" class="filter-select">
                                <option value="">Cualquier bono</option>
                            </select>
                        </div>
                        <div id="bonoManualFilter" style="display: none;">
                            <div style="display: flex; gap: 16px;">
                                <input type="text" id="filterBonoMin" class="filter-input" placeholder="M√≠nimo">
                                <input type="text" id="filterBonoMax" class="filter-input" placeholder="M√°ximo">
                            </div>
                        </div>
                    </div>

                    <div class="filter-card">
                        <label class="filter-label">
                            <span class="filter-icon">üè†</span>
                            Precio en UF
                            <div class="filter-toggle">
                                <button id="togglePrecioFilter" class="toggle-btn active" onclick="togglePrecioFilterType()">
                                    üìä Rangos Din√°micos
                                </button>
                            </div>
                        </label>
                        <div id="precioRangeFilter">
                            <select id="filterPrecio" class="filter-select">
                                <option value="">Cualquier precio</option>
                            </select>
                        </div>
                        <div id="precioManualFilter" style="display: none;">
                            <div style="display: flex; gap: 16px;">
                                <input type="text" id="filterPrecioMin" class="filter-input" placeholder="M√≠n UF">
                                <input type="text" id="filterPrecioMax" class="filter-input" placeholder="M√°x UF">
                            </div>
                        </div>
                    </div>

                    <div class="filter-card">
                        <label class="filter-label">
                            <span class="filter-icon">üìç</span>
                            Comuna
                        </label>
                        <select id="filterUbicacion" class="filter-select">
                            <option value="">Todas las comunas</option>
                        </select>
                    </div>

                    <div class="filter-card">
                        <label class="filter-label">
                            <span class="filter-icon">üè¢</span>
                            Tipolog√≠a
                        </label>
                        <select id="filterTipologia" class="filter-select">
                            <option value="">Todas las tipolog√≠as</option>
                        </select>
                    </div>
                </div>

                <div class="text-center">
                    <button class="action-btn" onclick="clearAllFilters()">
                        üîÑ Limpiar Filtros
                    </button>
                </div>
            </section>

            <!-- Secci√≥n de favoritos -->
            <section id="favoritesSection" class="favorites-section">
                <div class="favorites-header">
                    <h2 class="favorites-title">‚≠ê Mis Propiedades Favoritas</h2>
                    <div class="favorites-count" id="favorites-display-count">0 favoritos</div>
                </div>
                
                <!-- Panel de herramientas de favoritos -->
                <div class="favorites-tools" id="favoritesTools" style="display: none;">
                    <div class="tools-row">
                        <div class="tools-group">
                        </div>
                        
                        <div class="tools-group">
                            <button class="tool-btn" onclick="exportFavorites()" title="Exportar favoritos">
                                üìÑ Exportar PDF
                            </button>
                        </div>
                    </div>
                    
                </div>
                
                <div id="favorites-grid" class="properties-grid"></div>
            </section>
            
            <!-- Secci√≥n de comparador -->
            <section id="compareSection" class="compare-section">
                <div class="compare-header">
                    <h2 class="compare-title">üîÑ Comparar Propiedades</h2>
                    <div class="compare-count" id="compare-display-count">0 propiedades</div>
                </div>
                <div id="compare-content"></div>
            </section>
            
            <!-- Secci√≥n de propiedades -->
            <section class="properties-section">
                <div class="section-header">
                    <h2 class="section-title" id="section-title">Propiedades Disponibles</h2>
                    <div style="display: flex; align-items: center; gap: 24px;">
                        <div class="sort-container">
                            <label for="sortProperties" style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-right: 8px;">Ordenar por:</label>
                            <select id="sortProperties" class="filter-select" style="width: auto; min-width: 200px; padding: 12px 16px;">
                                <option value="bono-desc">üí∞ Mayor Bono</option>
                                <option value="bono-asc">üí∞ Menor Bono</option>
                                <option value="precio-desc">üè† Mayor Precio (UF)</option>
                                <option value="precio-asc">üè† Menor Precio (UF)</option>
                                <option value="cap-desc">üìà Mayor CAP Rate</option>
                                <option value="cap-asc">üìà Menor CAP Rate</option>
                            </select>
                        </div>
                        <div class="properties-count" id="properties-count">
                            0 propiedades
                        </div>
                    </div>
                </div>
                <div id="properties-grid" class="properties-grid"></div>
            </section>
        </main>

        <!-- Modal de detalles de propiedad -->
        <div id="propertyModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <div id="propertyDetails"></div>
            </div>
        </div>

        <!-- Modal de condiciones -->
        <div id="condicionesModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeCondicionesModal()">&times;</button>
                <div id="condicionesContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando t√©rminos y condiciones...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n flotante para volver arriba -->
    <button id="scrollToTop" class="scroll-to-top" onclick="scrollToTop()" title="Volver al inicio">
        <svg viewBox="0 0 24 24">
            <path d="M7 14l5-5 5 5H7z"/>
            <path d="M7 10l5-5 5 5H7z"/>
        </svg>
    </button>

    <script>
        // Variables globales
        const SPREADSHEET_ID = '1iF8PuF84cUNPZ3GM50guWsLwwp-slUZNbP0MWtaEPFM';
        const BONOS_GID = '725527455';
        const CONDICIONES_GID = '711460472';
        
        let propsData = [];
        let bonosData = [];
        let filteredProperties = [];
        let valorUF = 37643.59;
        
        // Variables para filtros
        let isBonoManualMode = false;
        let isPrecioManualMode = false;
        
        // Variable para condiciones
        let conditionsAccepted = localStorage.getItem('conditionsAccepted') === 'true';
        
        // Sistema de favoritos
        let favorites = JSON.parse(localStorage.getItem('propertyFavorites') || '[]');
        let showingFavorites = false;
        
        // Sistema de comparador
        let compareList = JSON.parse(localStorage.getItem('propertyCompare') || '[]');
        let showingCompare = false;

        // Funciones principales
        async function loadSheetData() {
            try {
                console.log('üöÄ Iniciando carga de datos desde Google Sheets...');
                
                const propsUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=0`;
                const bonosUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${BONOS_GID}`;
                
                console.log('üì° Cargando datos de propiedades...');
                const propsResponse = await fetch(propsUrl);
                
                if (!propsResponse.ok) {
                    throw new Error(`Error cargando propiedades: ${propsResponse.status}`);
                }
                
                const propsText = await propsResponse.text();
                console.log('üì° Cargando datos de bonos...');
                
                const bonosResponse = await fetch(bonosUrl);
                if (!bonosResponse.ok) {
                    throw new Error(`Error cargando bonos: ${bonosResponse.status}`);
                }
                
                const bonosText = await bonosResponse.text();
                
                return {
                    propsData: propsText,
                    bonosData: bonosText
                };
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                throw error;
            }
        }

        async function obtenerValorUF() {
            try {
                console.log('üí∞ Obteniendo valor UF actual...');
                const response = await fetch('https://mindicador.cl/api/uf');
                
                if (!response.ok) {
                    throw new Error('Error al obtener UF');
                }
                
                const data = await response.json();
                const valorActual = data.serie[0].valor;
                const fechaActual = new Date(data.serie[0].fecha).toLocaleDateString('es-CL');
                
                valorUF = valorActual;
                
                document.getElementById('uf-value').textContent = `$${valorActual.toLocaleString('es-CL')}`;
                document.getElementById('uf-date').textContent = fechaActual;
                
                console.log(`‚úÖ Valor UF actualizado: $${valorActual.toLocaleString('es-CL')}`);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error obteniendo UF, usando valor por defecto:', error);
                document.getElementById('uf-value').textContent = `$${valorUF.toLocaleString('es-CL')}`;
                document.getElementById('uf-date').textContent = 'Valor de referencia';
            }
        }

        function parseCSVData() {
            try {
                console.log('üîÑ Procesando datos CSV...');
                
                // Procesar datos de bonos
                const bonosLines = bonosData.split('\n');
                const bonosMap = new Map();
                
                for (let i = 1; i < bonosLines.length; i++) {
                    const row = parseCSVRow(bonosLines[i]);
                    if (row.length < 2) continue;
                    
                    const codigo = row[0]?.toString().trim();
                    const precio = parseFloat(row[1]?.toString().replace(/[^0-9.-]/g, '')) || 0;
                    const bono = parseFloat(row[4]?.toString().replace(/[^0-9.-]/g, '')) || 0;
                    const orden = parseFloat(row[6]?.toString().replace(/[^0-9.-]/g, '')) || 0;
                    
                    if (codigo && codigo.trim()) {
                        bonosMap.set(codigo.trim(), { precio, bono, orden });
                    }
                }
                
                console.log(`üìä Procesados ${bonosMap.size} bonos`);
                
                // Procesar propiedades
                const propsLines = propsData.split('\n');
                const properties = [];
                console.log('üóÇÔ∏è MAPEO DE COLUMNAS - Verificando datos:');
                const columnNames = {
                    'A': 'OP', 
                    'B': 'CONDOMINIO', 
                    'C': 'DIRECCI√ìN', 
                    'D': 'COMUNA', 
                    'E': 'DP',
                    'F': 'REGI√ìN', 
                    'G': 'TIPOLOGIA', 
                    'H': 'ORIENTACION', 
                    'I': 'TIPO',
                    'J': 'EST', 
                    'K': 'BOD', 
                    'L': 'M2 INTERIOR', 
                    'M': 'M2 TERR.',
                    'N': 'M2 TOTAL', 
                    'O': 'M2 PONDERADO', 
                    'P': 'A√ëO DE CONSTRUCCI√ìN', 
                    'Q': 'INMOBILIARIA',
                    'R': 'ESTADO DE ADMINISTRACI√ìN DE PROPIEDAD', 
                    'S': 'CANON DE ARRIENDO CONTRATO',
                    'AE': 'PRECIO FINAL DPTO',
                    'AF': 'UF/M2', 
                    'AI': 'ARRIENDO BRUTO ANUAL', 
                    'AJ': 'RENTABILIDAD BRUTA (ANUAL)', 
                    'AK': 'LINK PUBLICACI√ìN'
                };
                
                for (let i = 1; i < propsLines.length; i++) {
                    const row = parseCSVRow(propsLines[i]);
                    if (row.length < 2) continue;
                    
                    const codigo = row[0]?.toString().trim();
                    if (!codigo) continue;
                    
                    // Debug: verificar datos de la primera propiedad
                    if (i === 1) {
                        console.log('üìä Primera fila de datos:', {
                            totalColumnas: row.length,
                            codigo: row[0],
                            columnaW_rentabilidad: row[22],
                            columnaX_link: row[23],
                            todasLasColumnas: row.map((col, idx) => `[${idx}]: ${col}`)
                        });
                    }
                    
                    const bonoInfo = bonosMap.get(codigo) || { precio: 0, bono: 0, orden: 0 };
                    const precioFinal = bonoInfo.precio || 0;
                    
                    // Filtrar propiedades sin bono o con precio 0
                    if (precioFinal <= 0 || !bonoInfo.bono || bonoInfo.bono <= 0) {
                        console.log(`‚è≠Ô∏è Propiedad ${codigo} excluida: sin bono o precio 0 UF`);
                        continue;
                    }
                    
                    const property = {
                        id: codigo,
                        codigo: codigo,
                        precio: precioFinal,
                        bono: bonoInfo.bono,
                        ordenBono: bonoInfo.orden,
                        allData: {}
                    };
                    
                    // Agregar todos los datos de columnas
                    const excludedColumns = [32, 33]; // AG y AH (comisiones del vendedor)
                    for (let colIndex = 0; colIndex < row.length; colIndex++) {
                        if (!excludedColumns.includes(colIndex) && row[colIndex]) {
                            let columnLetter;
                            if (colIndex < 26) {
                                columnLetter = String.fromCharCode(65 + colIndex);
                            } else {
                                const firstLetter = String.fromCharCode(65 + Math.floor(colIndex / 26) - 1);
                                const secondLetter = String.fromCharCode(65 + (colIndex % 26));
                                columnLetter = firstLetter + secondLetter;
                            }
                            property.allData[columnLetter] = row[colIndex];
                        }
                    }
                    
                    // SOLO usar rentabilidad de la columna AJ del Google Sheets (RENTABILIDAD BRUTA ANUAL)
                    // NO calcular autom√°ticamente, respetar exactamente lo que est√° en la hoja
                    if (i < 5) {
                        console.log(`üìä Propiedad ${codigo} - Rentabilidad desde Sheets:`, {
                            columnaAJ: property.allData.AJ
                        });
                    }
                    
                    properties.push(property);
                }
                
                // Ordenar por orden de bono
                properties.sort((a, b) => (b.ordenBono || 0) - (a.ordenBono || 0));
                
                console.log(`‚úÖ Procesadas ${properties.length} propiedades v√°lidas`);
                return properties;
                
            } catch (error) {
                console.error('‚ùå Error procesando datos CSV:', error);
                return [];
            }
        }

        function calcularRentabilidadAutomatica(property) {
            try {
                const arriendoBrutoAnual = property.allData?.AI;
                const canonArriendo = property.allData?.S;
                const precioFinalUF = property.allData?.AE || property.precio;
                
                let arriendoAnual = 0;
                
                if (arriendoBrutoAnual && parseFloat(arriendoBrutoAnual) > 0) {
                    arriendoAnual = parseFloat(arriendoBrutoAnual);
                } else if (canonArriendo && parseFloat(canonArriendo) > 0) {
                    arriendoAnual = parseFloat(canonArriendo) * 12;
                }
                
                if (!arriendoAnual || !precioFinalUF || arriendoAnual <= 0) {
                    return null;
                }
                
                const precioNumerico = parseFloat(precioFinalUF.toString().replace(/[^0-9.-]/g, ''));
                if (isNaN(precioNumerico) || precioNumerico <= 0) {
                    return null;
                }
                
                const precioEnCLP = precioNumerico * valorUF;
                const rentabilidad = (arriendoAnual / precioEnCLP) * 100;
                
                return rentabilidad;
                
            } catch (error) {
                console.error('Error calculando rentabilidad:', error);
                return null;
            }
        }

        function parseCSVRow(csvRow) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvRow.length; i++) {
                const char = csvRow[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function generateFilters(properties) {
            console.log('üéõÔ∏è Generando filtros din√°micos...');
            
            // Generar rangos de bonos
            const bonos = properties
                .map(p => p.bono || 0)
                .filter(b => b > 0)
                .sort((a, b) => a - b);
                
            if (bonos.length > 0) {
                const bonoRanges = generateRanges(bonos, 'bono');
                populateSelect('filterBono', bonoRanges);
            }
            
            // Generar rangos de precios
            const precios = properties
                .map(p => p.precio || 0)
                .filter(p => p > 0)
                .sort((a, b) => a - b);
                
            if (precios.length > 0) {
                const precioRanges = generateRanges(precios, 'precio');
                populateSelect('filterPrecio', precioRanges);
            }
            
            // Generar opciones de ubicaci√≥n
            const ubicaciones = [...new Set(properties
                .map(p => p.allData?.D)
                .filter(u => u && u.trim())
                .map(u => u.trim())
            )].sort();
            
            populateSelectOptions('filterUbicacion', ubicaciones);
            
            // Generar opciones de tipolog√≠a
            const tipologias = [...new Set(properties
                .map(p => p.allData?.G)
                .filter(t => t && t.trim())
                .map(t => t.trim())
            )].sort();
            
            populateSelectOptions('filterTipologia', tipologias);
            
            console.log('‚úÖ Filtros generados correctamente');
        }

        function generateRanges(values, type) {
            if (values.length === 0) return [];
            
            const min = values[0];
            const max = values[values.length - 1];
            const ranges = [];
            
            if (type === 'bono') {
                const step = Math.ceil((max - min) / 5);
                let current = min;
                
                while (current < max) {
                    const rangeEnd = Math.min(current + step, max);
                    ranges.push({
                        label: `$${current.toLocaleString()} - $${rangeEnd.toLocaleString()}`,
                        value: `${current}-${rangeEnd}`
                    });
                    current = rangeEnd + 1;
                }
            } else if (type === 'precio') {
                const step = Math.ceil((max - min) / 6);
                let current = min;
                
                while (current < max) {
                    const rangeEnd = Math.min(current + step, max);
                    ranges.push({
                        label: `${current.toLocaleString()} - ${rangeEnd.toLocaleString()} UF`,
                        value: `${current}-${rangeEnd}`
                    });
                    current = rangeEnd + 1;
                }
            }
            
            return ranges;
        }

        function populateSelect(selectId, ranges) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Mantener la opci√≥n por defecto
            const defaultOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(defaultOption);
            
            ranges.forEach(range => {
                const option = document.createElement('option');
                option.value = range.value;
                option.textContent = range.label;
                select.appendChild(option);
            });
        }

        function populateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Mantener la opci√≥n por defecto
            const defaultOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(defaultOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        function applyFilters() {
            const filters = getFilterValues();
            
            filteredProperties = propsData.filter(property => {
                // Filtro de bono
                const bono = Number(property.bono) || 0;
                if (filters.bonoMin === 0 && filters.bonoMax === 0) {
                    if (bono !== 0) return false;
                } else {
                    if (bono < filters.bonoMin || bono > filters.bonoMax) return false;
                }
                
                // Filtro de precio
                const precio = Number(property.precio) || 0;
                if (precio < filters.precioMin || precio > filters.precioMax) return false;
                
                // Filtro de ubicaci√≥n
                if (filters.ubicacion) {
                    const comuna = property.allData?.D?.toString().trim() || '';
                    if (!comuna.toLowerCase().includes(filters.ubicacion.toLowerCase())) return false;
                }
                
                // Filtro de tipolog√≠a
                if (filters.tipologia) {
                    const tipologia = property.allData?.G?.toString().trim() || '';
                    if (!tipologia.toLowerCase().includes(filters.tipologia.toLowerCase())) return false;
                }
                
                return true;
            });
            
            sortAndDisplayProperties();
            updatePropertiesCount(filteredProperties.length);
        }

        function getFilterValues() {
            const filters = {
                bonoMin: 0,
                bonoMax: Infinity,
                precioMin: 0,
                precioMax: Infinity,
                ubicacion: '',
                tipologia: ''
            };
            
            // Filtros de bono
            if (isBonoManualMode) {
                const minVal = document.getElementById('filterBonoMin').value;
                const maxVal = document.getElementById('filterBonoMax').value;
                filters.bonoMin = minVal ? parseFloat(minVal.replace(/,/g, '')) : 0;
                filters.bonoMax = maxVal ? parseFloat(maxVal.replace(/,/g, '')) : Infinity;
            } else {
                const bonoRange = document.getElementById('filterBono').value;
                if (bonoRange) {
                    const [min, max] = bonoRange.split('-').map(Number);
                    filters.bonoMin = min;
                    filters.bonoMax = max;
                }
            }
            
            // Filtros de precio
            if (isPrecioManualMode) {
                const minVal = document.getElementById('filterPrecioMin').value;
                const maxVal = document.getElementById('filterPrecioMax').value;
                filters.precioMin = minVal ? parseFloat(minVal.replace(/,/g, '')) : 0;
                filters.precioMax = maxVal ? parseFloat(maxVal.replace(/,/g, '')) : Infinity;
            } else {
                const precioRange = document.getElementById('filterPrecio').value;
                if (precioRange) {
                    const [min, max] = precioRange.split('-').map(Number);
                    filters.precioMin = min;
                    filters.precioMax = max;
                }
            }
            
            // Otros filtros
            filters.ubicacion = document.getElementById('filterUbicacion').value;
            filters.tipologia = document.getElementById('filterTipologia').value;
            
            return filters;
        }

        function sortAndDisplayProperties() {
            const sortValue = document.getElementById('sortProperties')?.value || 'bono-desc';
            let sortedProperties = [...filteredProperties];
            
            switch(sortValue) {
                case 'bono-desc':
                    sortedProperties.sort((a, b) => (b.bono || 0) - (a.bono || 0));
                    break;
                case 'bono-asc':
                    sortedProperties.sort((a, b) => (a.bono || 0) - (b.bono || 0));
                    break;
                case 'precio-desc':
                    sortedProperties.sort((a, b) => (b.precio || 0) - (a.precio || 0));
                    break;
                case 'precio-asc':
                    sortedProperties.sort((a, b) => (a.precio || 0) - (b.precio || 0));
                    break;
                case 'cap-desc':
                    sortedProperties.sort((a, b) => {
                        const capA = parseFloat(a.allData?.AJ?.replace('%', '') || '0');
                        const capB = parseFloat(b.allData?.AJ?.replace('%', '') || '0');
                        return capB - capA;
                    });
                    break;
                case 'cap-asc':
                    sortedProperties.sort((a, b) => {
                        const capA = parseFloat(a.allData?.AJ?.replace('%', '') || '0');
                        const capB = parseFloat(b.allData?.AJ?.replace('%', '') || '0');
                        return capA - capB;
                    });
                    break;
            }
            
            displayProperties(sortedProperties);
        }

        function displayProperties(properties) {
            const gridEl = document.getElementById('properties-grid');
            gridEl.innerHTML = '';
            
            if (properties.length === 0) {
                gridEl.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">üè†</div>
                        <h3 style="font-size: 2rem; margin-bottom: 16px;">No se encontraron propiedades</h3>
                        <p style="font-size: 1.2rem; margin-bottom: 32px;">Intenta ajustar los filtros para ver m√°s resultados</p>
                        <button class="action-btn" onclick="clearAllFilters()">üîÑ Limpiar Filtros</button>
                    </div>
                `;
                return;
            }
            
            // Renderizar propiedades en lotes para mejor performance
            const batchSize = 30;
            let currentIndex = 0;
            
            function renderBatch() {
                const fragment = document.createDocumentFragment();
                const end = Math.min(currentIndex + batchSize, properties.length);
                
                for (let i = currentIndex; i < end; i++) {
                    const card = createPropertyCard(properties[i], i);
                    fragment.appendChild(card);
                }
                
                gridEl.appendChild(fragment);
                currentIndex = end;
                
                if (currentIndex < properties.length) {
                    requestAnimationFrame(renderBatch);
                }
            }
            
            requestAnimationFrame(renderBatch);
        }

        function createPropertyCard(property, index) {
            const card = document.createElement('div');
            card.className = 'property-card';
            card.style.animationDelay = `${Math.min(index * 0.05, 1)}s`;
            
            const precioUF = Math.round(property.precio || 0);
            const precioCLP = precioUF * valorUF;
            const cardId = `${property.codigo}-${index}`;
            
            // Determinar informaci√≥n de bono
            const bono = property.bono || 0;
            const bonoHtml = bono > 0 
                ? `<div class="bono-badge">üéÅ Bono: $${Math.round(bono).toLocaleString()}</div>`
                : '<div class="bono-badge" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6);">Sin bono disponible</div>';
            
            // USAR EXACTAMENTE la rentabilidad de la columna AJ del Google Sheets
            const rentabilidadSheets = property.allData?.AJ;
            const rentabilidad = rentabilidadSheets ? parseFloat(rentabilidadSheets) : null;
            
            // Debug: confirmar que se usa el valor exacto del Sheets
            if (index < 3) {
                console.log(`üìã Propiedad ${property.codigo} - Rentabilidad del Sheets:`, {
                    valorOriginalAJ: rentabilidadSheets,
                    valorMostrado: rentabilidad
                });
            }
            
            // Combinar CAP RATE, comuna y tipolog√≠a en una sola l√≠nea
            let infoHtml = '';
            const capRatePart = rentabilidad && rentabilidad > 0 ? `CAP RATE: <strong>${rentabilidadSheets}</strong> ‚Ä¢ ` : '';
            const comunaPart = property.allData?.D || 'Comuna N/D';
            const tipologiaPart = property.allData?.G || 'Tipo N/D';
            
            infoHtml = `
                <div class="rentabilidad-indicator">
                    ${capRatePart}üìç ${comunaPart} ‚Ä¢ üè¢ ${tipologiaPart}
                </div>
            `;
            
            card.innerHTML = `
                <div class="card-header">
                    <button class="favorite-btn ${favorites.includes(property.codigo) ? 'active' : ''}" 
                            onclick="toggleFavorite('${property.codigo}')" 
                            title="${favorites.includes(property.codigo) ? 'Quitar de favoritos' : 'Agregar a favoritos'}">
                        ${favorites.includes(property.codigo) ? '‚≠ê' : '‚òÜ'}
                    </button>
                    <button class="compare-btn ${compareList.includes(property.codigo) ? 'active' : ''}" 
                            onclick="toggleCompareProperty('${property.codigo}')" 
                            title="${compareList.includes(property.codigo) ? 'Quitar de comparaci√≥n' : 'Agregar para comparar'}">
                        ${compareList.includes(property.codigo) ? 'üîÑ' : '‚öñÔ∏è'}
                    </button>
                    <div class="property-code" onclick="copyToClipboard('${property.codigo}')" title="Clic para copiar">
                        <div style="font-size: 0.65rem; opacity: 0.8; margin-bottom: 2px;">C√ìDIGO</div>
                        <div style="font-weight: 700;">${property.codigo}</div>
                        <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 1px;">Presionar para copiar</div>
                    </div>
                    <div class="property-price" id="price-${cardId}" data-showing="uf" onclick="togglePrecio('${cardId}', ${precioUF})">
                        ${precioUF.toLocaleString()} UF
                    </div>
                    <div class="price-label" id="price-label-${cardId}">
                        Precio en UF ‚Ä¢ Presiona para cambiar a CLP
                    </div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 8px;">
                        ${property.allData?.I || 'Tipo N/D'} ‚Ä¢ 
                        EST: ${property.allData?.J || '0'} ‚Ä¢ 
                        BOD: ${property.allData?.K || '0'}
                    </div>
                </div>
                
                <div class="card-content">
                    ${bonoHtml}
                    ${infoHtml}
                    <div class="card-actions">
                        <button class="btn-primary" onclick="showPropertyModal('${property.codigo}')">
                            üìã Ver Detalles y Publicaci√≥n
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function togglePrecio(cardId, precioUF) {
            const priceEl = document.getElementById(`price-${cardId}`);
            const labelEl = document.getElementById(`price-label-${cardId}`);
            const isShowingUF = priceEl.dataset.showing === 'uf';
            
            if (isShowingUF) {
                const precioCLP = precioUF * valorUF;
                priceEl.textContent = `$${Math.round(precioCLP).toLocaleString()}`;
                priceEl.dataset.showing = 'clp';
                labelEl.textContent = 'Precio en CLP ‚Ä¢ Presiona para cambiar a UF';
            } else {
                priceEl.textContent = `${precioUF.toLocaleString()} UF`;
                priceEl.dataset.showing = 'uf';
                labelEl.textContent = 'Precio en UF ‚Ä¢ Presiona para cambiar a CLP';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Mostrar feedback visual
                const event = new CustomEvent('show-toast', {
                    detail: { message: `C√≥digo ${text} copiado al portapapeles` }
                });
                window.dispatchEvent(event);
            });
        }

        function showPropertyModal(codigo) {
            const property = propsData.find(p => p.codigo === codigo);
            if (!property) return;
            
            const modal = document.getElementById('propertyModal');
            const content = document.getElementById('propertyDetails');
            
            const columnNames = {
                'A': 'OP', 
                'B': 'CONDOMINIO', 
                'C': 'DIRECCI√ìN', 
                'D': 'COMUNA', 
                'E': 'DP',
                'F': 'REGI√ìN', 
                'G': 'TIPOLOGIA', 
                'H': 'ORIENTACION', 
                'I': 'TIPO',
                'J': 'EST', 
                'K': 'BOD', 
                'L': 'M2 INTERIOR', 
                'M': 'M2 TERR.',
                'N': 'M2 TOTAL', 
                'O': 'M2 PONDERADO', 
                'P': 'A√ëO DE CONSTRUCCI√ìN', 
                'Q': 'INMOBILIARIA',
                'R': 'ESTADO DE ADMINISTRACI√ìN DE PROPIEDAD', 
                'S': 'CANON DE ARRIENDO CONTRATO',
                'AE': 'PRECIO FINAL DPTO',
                'AF': 'UF/M2', 
                'AI': 'ARRIENDO BRUTO ANUAL', 
                'AJ': 'RENTABILIDAD BRUTA (ANUAL)', 
                'AK': 'LINK PUBLICACI√ìN'
            };
            
            let detailsHtml = `
                <div class="text-center mb-4">
                    <div class="brand-icon" style="width: 60px; height: 60px; margin: 0 auto 16px;">üè†</div>
                    <h2 style="font-size: 2rem; margin-bottom: 8px;">Propiedad ${property.codigo}</h2>
                    <p style="color: rgba(255,255,255,0.7);">Informaci√≥n detallada completa</p>
                </div>
                
                <div style="display: grid; gap: 16px;">
            `;
            
            Object.entries(columnNames).forEach(([column, name]) => {
                const value = property.allData[column];
                if (value && value.toString().trim()) {
                    let displayValue = value.toString();
                    
                    // Formatear el LINK PUBLICACI√ìN de manera especial
                    if (column === 'AK' && displayValue.startsWith('http')) {
                        detailsHtml += `
                            <div style="background: linear-gradient(135deg, #FF6B6B, #FF1493); padding: 24px; border-radius: 20px; margin: 20px 0; text-align: center; box-shadow: 0 8px 32px rgba(255, 107, 107, 0.3);">
                                <div style="color: white; font-size: 1.1rem; font-weight: 600; margin-bottom: 12px;">
                                    üè† PUBLICACI√ìN COMPLETA
                                </div>
                                <a href="${displayValue}" target="_blank" style="
                                    display: inline-block;
                                    background: white;
                                    color: #FF6B6B;
                                    padding: 16px 32px;
                                    border-radius: 16px;
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                    text-decoration: none;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                                " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.1)'">
                                    üìç VER PROPIEDAD EN SITIO WEB
                                </a>
                                <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-top: 12px;">
                                    Click para ver fotos, ubicaci√≥n y m√°s detalles
                                </div>
                            </div>
                        `;
                    } else if (displayValue.startsWith('http')) {
                        // Otros enlaces normales
                        displayValue = `<a href="${displayValue}" target="_blank" style="color: #FF6B6B; text-decoration: none;">üîó Ver enlace</a>`;
                        detailsHtml += `
                            <div class="info-row">
                                <span class="info-label">${name}:</span>
                                <span class="info-value">${displayValue}</span>
                            </div>
                        `;
                    } else {
                        // Datos normales
                        detailsHtml += `
                            <div class="info-row">
                                <span class="info-label">${name}:</span>
                                <span class="info-value">${displayValue}</span>
                            </div>
                        `;
                    }
                }
            });
            
            detailsHtml += '</div>';
            content.innerHTML = detailsHtml;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('propertyModal').style.display = 'none';
        }

        function updatePropertiesCount(count) {
            const countEl = document.getElementById('properties-count');
            countEl.textContent = `${count} ${count === 1 ? 'propiedad' : 'propiedades'}`;
        }

        // Funciones de filtros
        function toggleBonoFilterType() {
            isBonoManualMode = !isBonoManualMode;
            const rangeFilter = document.getElementById('bonoRangeFilter');
            const manualFilter = document.getElementById('bonoManualFilter');
            const toggleBtn = document.getElementById('toggleBonoFilter');
            
            if (isBonoManualMode) {
                rangeFilter.style.display = 'none';
                manualFilter.style.display = 'block';
                toggleBtn.textContent = 'üìä Cambiar a Rangos';
                toggleBtn.classList.remove('active');
            } else {
                rangeFilter.style.display = 'block';
                manualFilter.style.display = 'none';
                toggleBtn.textContent = '‚öôÔ∏è Cambiar a Manual';
                toggleBtn.classList.add('active');
            }
        }

        function togglePrecioFilterType() {
            isPrecioManualMode = !isPrecioManualMode;
            const rangeFilter = document.getElementById('precioRangeFilter');
            const manualFilter = document.getElementById('precioManualFilter');
            const toggleBtn = document.getElementById('togglePrecioFilter');
            
            if (isPrecioManualMode) {
                rangeFilter.style.display = 'none';
                manualFilter.style.display = 'block';
                toggleBtn.textContent = 'üìä Cambiar a Rangos';
                toggleBtn.classList.remove('active');
            } else {
                rangeFilter.style.display = 'block';
                manualFilter.style.display = 'none';
                toggleBtn.textContent = '‚öôÔ∏è Cambiar a Manual';
                toggleBtn.classList.add('active');
            }
        }

        function clearAllFilters() {
            // Resetear filtros
            document.getElementById('filterBono').value = '';
            document.getElementById('filterPrecio').value = '';
            document.getElementById('filterUbicacion').value = '';
            document.getElementById('filterTipologia').value = '';
            document.getElementById('filterBonoMin').value = '';
            document.getElementById('filterBonoMax').value = '';
            document.getElementById('filterPrecioMin').value = '';
            document.getElementById('filterPrecioMax').value = '';
            
            // Aplicar filtros
            applyFilters();
        }

        // Funciones para condiciones
        async function loadCondiciones() {
            console.log('üìã Cargando condiciones desde Google Sheets...');
            
            try {
                const condicionesUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${CONDICIONES_GID}`;
                const response = await fetch(condicionesUrl);
                
                if (!response.ok) {
                    throw new Error('Error al cargar condiciones');
                }
                
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                let content = '<div style="line-height: 1.8; font-size: 1.1rem;">';
                
                lines.forEach((line, index) => {
                    const cleanLine = line.replace(/"/g, '').trim();
                    if (cleanLine) {
                        if (index === 0) {
                            content += `<h2 style="color: #FF6B6B; margin-bottom: 24px; text-align: center;">${cleanLine}</h2>`;
                        } else {
                            content += `<p style="margin-bottom: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">${cleanLine}</p>`;
                        }
                    }
                });
                
                content += '</div>';
                return content;
                
            } catch (error) {
                console.error('‚ùå Error cargando condiciones:', error);
                return `
                    <div style="text-align: center; line-height: 1.8;">
                        <h2 style="color: #FF6B6B; margin-bottom: 24px;">T√©rminos y Condiciones - TuMatch Inmobiliario</h2>
                        <p><strong>TuMatch Inmobiliario</strong> es una plataforma digital que facilita la b√∫squeda de propiedades inmobiliarias con bonos disponibles.</p>
                        <p style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.2);">Al utilizar esta plataforma, usted <strong>reconoce haber le√≠do</strong> y acepta estos t√©rminos y condiciones.</p>
                    </div>
                `;
            }
        }

        function showCondicionesModal() {
            const modal = document.getElementById('condicionesModal');
            const content = document.getElementById('condicionesContent');
            
            modal.style.display = 'flex';
            
            loadCondiciones().then(html => {
                content.innerHTML = html;
            });
        }

        function closeCondicionesModal() {
            document.getElementById('condicionesModal').style.display = 'none';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando aplicaci√≥n TuMatch Inmobiliario...');
            
            try {
                // Cargar valor UF
                await obtenerValorUF();
                
                // Cargar datos
                const sheetsData = await loadSheetData();
                propsData = sheetsData.propsData;
                bonosData = sheetsData.bonosData;
                
                // Procesar datos
                const properties = parseCSVData();
                propsData = properties;
                filteredProperties = [...properties];
                
                // Generar filtros
                generateFilters(properties);
                
                // Mostrar propiedades
                sortAndDisplayProperties();
                updatePropertiesCount(filteredProperties.length);
                
                // Configurar listeners de filtros
                setupFilterListeners();
                
                // Inicializar contadores
                updateFavoritesCounter();
                updateCompareCounter();
                
                // Mostrar contenido
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').classList.remove('hidden');
                
                console.log('‚úÖ Aplicaci√≥n iniciada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error iniciando aplicaci√≥n:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <h3>Error cargando datos</h3>
                        <p>No se pudieron cargar las propiedades. Por favor, recarga la p√°gina.</p>
                        <button class="action-btn" onclick="location.reload()">üîÑ Recargar</button>
                    </div>
                `;
            }
        });

        function setupFilterListeners() {
            const filterElements = [
                'filterBono', 'filterPrecio', 'filterUbicacion', 'filterTipologia',
                'filterBonoMin', 'filterBonoMax', 'filterPrecioMin', 'filterPrecioMax'
            ];
            
            filterElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                    element.addEventListener('input', applyFilters);
                }
            });
            
            // Agregar listener para el ordenamiento
            const sortElement = document.getElementById('sortProperties');
            if (sortElement) {
                sortElement.addEventListener('change', sortAndDisplayProperties);
            }
        }

        // Cerrar modales al hacer clic fuera
        document.addEventListener('click', (e) => {
            const modals = ['propertyModal', 'condicionesModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Sistema de Favoritos
        function toggleFavorite(codigo) {
            event.stopPropagation();
            
            if (favorites.includes(codigo)) {
                favorites = favorites.filter(fav => fav !== codigo);
                showToast(`Propiedad ${codigo} quitada de favoritos`);
            } else {
                favorites.push(codigo);
                showToast(`Propiedad ${codigo} agregada a favoritos`);
            }
            
            localStorage.setItem('propertyFavorites', JSON.stringify(favorites));
            updateFavoritesCounter();
            
            if (showingFavorites) {
                displayFavorites();
            } else {
                // Actualizar bot√≥n de favorito en la card actual
                const card = event.target.closest('.property-card');
                const favBtn = card.querySelector('.favorite-btn');
                const isFavorite = favorites.includes(codigo);
                
                favBtn.classList.toggle('active', isFavorite);
                favBtn.textContent = isFavorite ? '‚≠ê' : '‚òÜ';
                favBtn.title = isFavorite ? 'Quitar de favoritos' : 'Agregar a favoritos';
            }
        }
        
        function updateFavoritesCounter() {
            document.getElementById('favoritesCount').textContent = favorites.length;
            document.getElementById('favorites-display-count').textContent = 
                `${favorites.length} ${favorites.length === 1 ? 'favorito' : 'favoritos'}`;
        }
        
        function toggleFavorites() {
            showingFavorites = !showingFavorites;
            const favoritesSection = document.getElementById('favoritesSection');
            const compareSection = document.getElementById('compareSection');
            const propertiesSection = document.querySelector('.properties-section');
            const filtersSection = document.querySelector('.filters-section');
            const toggleBtn = document.getElementById('toggleFavoritesBtn');
            
            if (showingFavorites) {
                displayFavorites();
                favoritesSection.classList.add('active');
                compareSection.classList.remove('active');
                propertiesSection.style.display = 'none';
                filtersSection.style.display = 'none';
                showingCompare = false;
                toggleBtn.textContent = `‚≠ê Ver Todas Las Propiedades (${favorites.length})`;
            } else {
                favoritesSection.classList.remove('active');
                propertiesSection.style.display = 'block';
                filtersSection.style.display = 'block';
                sortAndDisplayProperties();
                toggleBtn.innerHTML = `‚≠ê Mis Favoritos (<span id="favoritesCount">${favorites.length}</span>)`;
            }
        }
        
        function displayFavorites() {
            const favoritesGrid = document.getElementById('favorites-grid');
            const favoritesTools = document.getElementById('favoritesTools');
            const favoriteProperties = propsData.filter(prop => favorites.includes(prop.codigo));
            
            if (favoriteProperties.length === 0) {
                // Ocultar herramientas si no hay favoritos
                favoritesTools.style.display = 'none';
                favoritesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">‚≠ê</div>
                        <h3 style="font-size: 2rem; margin-bottom: 16px; color: #FFD700;">No tienes favoritos a√∫n</h3>
                        <p style="font-size: 1.2rem; margin-bottom: 32px;">Agrega propiedades a favoritos haciendo clic en la estrella ‚òÜ</p>
                        <button class="toggle-favorites-btn" onclick="toggleFavorites()">üè† Ver Todas Las Propiedades</button>
                    </div>
                `;
                return;
            }

            // Mostrar herramientas si hay favoritos
            favoritesTools.style.display = 'block';
            
            favoritesGrid.innerHTML = '';
            favoriteProperties.forEach((property, index) => {
                const card = createPropertyCard(property, index);
                favoritesGrid.appendChild(card);
            });
        }
        
        function showToast(message) {
            const event = new CustomEvent('show-toast', {
                detail: { message }
            });
            window.dispatchEvent(event);
        }
        
        // Sistema de Comparador
        function toggleCompareProperty(codigo) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            if (compareList.includes(codigo)) {
                compareList = compareList.filter(comp => comp !== codigo);
                showToast(`Propiedad ${codigo} quitada de comparaci√≥n`);
            } else {
                if (compareList.length >= 4) {
                    showToast('M√°ximo 4 propiedades para comparar');
                    return;
                }
                compareList.push(codigo);
                showToast(`Propiedad ${codigo} agregada para comparar`);
            }
            
            localStorage.setItem('propertyCompare', JSON.stringify(compareList));
            updateCompareCounter();
            
            // Actualizar solo el bot√≥n que se clicke√≥
            const clickedButton = event.target;
            const isInCompare = compareList.includes(codigo);
            clickedButton.classList.toggle('active', isInCompare);
            clickedButton.textContent = isInCompare ? 'üîÑ' : '‚öñÔ∏è';
            clickedButton.title = isInCompare ? 'Quitar de comparaci√≥n' : 'Agregar para comparar';
            
            // Si estamos en la vista de comparar, actualizarla
            if (showingCompare) {
                displayCompare();
            }
        }
        
        function updateCompareButtons() {
            console.log('Actualizando botones de comparar. Lista actual:', compareList);
            document.querySelectorAll('.compare-btn').forEach(btn => {
                const onclickStr = btn.getAttribute('onclick');
                if (onclickStr) {
                    const codigo = onclickStr.match(/'([^']+)'/)?.[1];
                    if (codigo) {
                        const isInCompare = compareList.includes(codigo);
                        btn.classList.toggle('active', isInCompare);
                        btn.textContent = isInCompare ? 'üîÑ' : '‚öñÔ∏è';
                        btn.title = isInCompare ? 'Quitar de comparaci√≥n' : 'Agregar para comparar';
                    }
                }
            });
        }
        
        function updateCompareCounter() {
            document.getElementById('compareCount').textContent = compareList.length;
            document.getElementById('compare-display-count').textContent = 
                `${compareList.length} ${compareList.length === 1 ? 'propiedad' : 'propiedades'}`;
        }
        
        function toggleCompare() {
            showingCompare = !showingCompare;
            const compareSection = document.getElementById('compareSection');
            const propertiesSection = document.querySelector('.properties-section');
            const favoritesSection = document.getElementById('favoritesSection');
            const filtersSection = document.querySelector('.filters-section');
            const toggleBtn = document.getElementById('toggleCompareBtn');
            
            if (showingCompare) {
                displayCompare();
                compareSection.classList.add('active');
                favoritesSection.classList.remove('active');
                propertiesSection.style.display = 'none';
                filtersSection.style.display = 'none';
                showingFavorites = false;
                toggleBtn.textContent = `üîÑ Ver Todas Las Propiedades (${compareList.length})`;
                // Actualizar el bot√≥n de favoritos tambi√©n
                document.getElementById('toggleFavoritesBtn').innerHTML = `‚≠ê Mis Favoritos (<span id="favoritesCount">${favorites.length}</span>)`;
            } else {
                compareSection.classList.remove('active');
                propertiesSection.style.display = 'block';
                filtersSection.style.display = 'block';
                sortAndDisplayProperties();
                toggleBtn.innerHTML = `üîÑ Comparar (<span id="compareCount">${compareList.length}</span>)`;
            }
        }
        
        function displayCompare() {
            console.log('üöÄ INICIANDO displayCompare()');
            console.log('üìã Lista actual:', compareList);
            console.log('üìä compareList.length:', compareList.length);
            
            const compareContent = document.getElementById('compare-content');
            console.log('üéØ Elemento compare-content:', compareContent);
            
            const compareProperties = propsData.filter(prop => compareList.includes(prop.codigo));
            console.log('üèòÔ∏è Propiedades encontradas para comparar:', compareProperties.length);
            console.log('üìù C√≥digos de propiedades encontradas:', compareProperties.map(p => p.codigo));
            
            if (compareProperties.length === 0) {
                console.log('No hay propiedades, mostrando estado vac√≠o');
                compareContent.innerHTML = `
                    <div class=\"empty-state\" style=\"text-align: center; padding: 60px 20px;\">
                        <div class=\"empty-icon\" style=\"font-size: 4rem; margin-bottom: 24px;\">‚öñÔ∏è</div>
                        <h3 style=\"font-size: 2rem; margin-bottom: 16px; color: #8A2BE2;\">No hay propiedades para comparar</h3>
                        <p style=\"font-size: 1.2rem; margin-bottom: 32px;\">Agrega propiedades haciendo clic en ‚öñÔ∏è (m√°ximo 4)</p>
                        <button class=\"toggle-compare-btn\" onclick=\"showAllProperties()\">üè† Ver Todas Las Propiedades</button>
                    </div>
                `;
                return;
            }
            
            let tableHtml = `
                <table class=\"compare-table\">
                    <thead>
                        <tr>
                            <th style=\"text-align: left; width: 200px;\">Caracter√≠stica</th>
            `;
            
            compareProperties.forEach((property, index) => {
                tableHtml += `
                    <th>
                        <div style=\"margin-bottom: 8px;\">${property.codigo}</div>
                        <button class=\"remove-compare\" data-codigo=\"${property.codigo}\" data-index=\"${index}\">
                            ‚ùå Quitar
                        </button>
                    </th>
                `;
            });
            
            tableHtml += '</tr></thead><tbody>';
            
            const compareFields = [
                { key: 'precio', label: 'Precio Final UF', format: (val) => val ? `${parseFloat(val).toLocaleString()} UF` : 'N/D' },
                { key: 'I', label: 'Tipo', format: (val) => val || 'N/D' },
                { key: 'G', label: 'Tipolog√≠a', format: (val) => val || 'N/D' },
                { key: 'D', label: 'Comuna', format: (val) => val || 'N/D' },
                { key: 'L', label: 'M¬≤ Interior', format: (val) => val ? `${val} m¬≤` : 'N/D' },
                { key: 'M', label: 'M¬≤ Terraza', format: (val) => val ? `${val} m¬≤` : 'N/D' },
                { key: 'N', label: 'M¬≤ Total', format: (val) => val ? `${val} m¬≤` : 'N/D' },
                { key: 'J', label: 'Estacionamientos', format: (val) => val || '0' },
                { key: 'K', label: 'Bodegas', format: (val) => val || '0' },
                { key: 'AJ', label: 'CAP RATE', format: (val) => val || 'N/D' },
                { key: 'AF', label: 'UF/M¬≤', format: (val) => val ? `${parseFloat(val).toLocaleString()} UF/m¬≤` : 'N/D' },
                { key: 'S', label: 'Canon Arriendo', format: (val) => val ? `$${parseFloat(val).toLocaleString()}` : 'N/D' }
            ];
            
            compareFields.forEach(field => {
                tableHtml += `<tr><td class=\"row-label\">${field.label}</td>`;
                compareProperties.forEach(property => {
                    let value;
                    if (field.key === 'precio') {
                        value = property.precio;
                    } else {
                        value = property.allData?.[field.key];
                    }
                    tableHtml += `<td>${field.format(value)}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            // Agregar bono info
            tableHtml += `<tr><td class=\"row-label\">Bono Disponible</td>`;
            compareProperties.forEach(property => {
                const bono = property.bono || 0;
                tableHtml += `<td>${bono > 0 ? `$${Math.round(bono).toLocaleString()}` : 'Sin bono'}</td>`;
            });
            tableHtml += '</tr>';
            
            tableHtml += '</tbody></table>';
            
            // A√±adir acciones del comparador
            tableHtml += `
                <div class="compare-actions">
                    <button class="compare-action-btn" onclick="highlightBestValues()">
                        üèÜ Destacar Mejores Valores
                    </button>
                    <button class="compare-action-btn" onclick="exportComparison()">
                        üìä Exportar Comparaci√≥n
                    </button>
                    <button class="compare-action-btn" onclick="calculateRecommendation()">
                        üß† Recomendaci√≥n IA
                    </button>
                    <button class="compare-action-btn" onclick="event.stopPropagation(); clearAllComparisons()">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
            `;
            
            console.log('HTML de tabla generado, longitud:', tableHtml.length);
            compareContent.innerHTML = tableHtml;
            console.log('‚úÖ Contenido HTML actualizado en DOM');
            console.log('üìÑ Nuevo innerHTML length:', compareContent.innerHTML.length);
            console.log('üîç Verificando si botones fueron creados:', compareContent.querySelectorAll('.remove-compare').length);
            
            // AGREGAR EVENT LISTENERS a todos los botones quitar INMEDIATAMENTE despu√©s de crear la tabla
            document.querySelectorAll('.remove-compare').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const codigoToRemove = this.getAttribute('data-codigo');
                    console.log('üéØ CLICK DETECTADO en bot√≥n quitar para:', codigoToRemove);
                    removeFromCompare(codigoToRemove);
                });
            });
            console.log('üéØ Event listeners agregados a', document.querySelectorAll('.remove-compare').length, 'botones');
        }
        
        function removeFromCompare(codigo) {
            // Quitar de la lista
            compareList = compareList.filter(comp => comp !== codigo);
            localStorage.setItem('propertyCompare', JSON.stringify(compareList));
            updateCompareCounter();
            updateCompareButtons();
            
            // EN LOCAL: Simular F5 refrescando todo el estado
            showingCompare = false;
            showingFavorites = false;
            
            // Ocultar todas las vistas
            document.getElementById('compare-content').style.display = 'none';
            document.getElementById('favorites-content').style.display = 'none';
            document.getElementById('compareSection').classList.remove('active');
            document.getElementById('favoritesSection').classList.remove('active');
            
            // Mostrar vista principal
            document.querySelector('.properties-section').style.display = 'block';
            document.querySelector('.filters-section').style.display = 'block';
            document.getElementById('property-list').style.display = 'grid';
            
            // Actualizar botones
            document.getElementById('toggleCompareBtn').innerHTML = `üîÑ Comparar (<span id="compareCount">${compareList.length}</span>)`;
            
            showToast(`Propiedad ${codigo} eliminada`);
        }

        function showAllProperties() {
            console.log('Volviendo a vista de todas las propiedades');
            showingCompare = false;
            showingFavorites = false;
            
            const compareContent = document.getElementById('compare-content');
            const favoritesContent = document.getElementById('favorites-content');
            
            compareContent.style.display = 'none';
            favoritesContent.style.display = 'none';
            document.getElementById('property-list').style.display = 'grid';
            
            updateCompareCounter();
        }

        // =====================================================
        // FUNCIONES AVANZADAS PARA FAVORITOS
        // =====================================================



        function exportFavorites() {
            const favoriteProperties = propsData.filter(prop => favorites.includes(prop.codigo));
            
            if (favoriteProperties.length === 0) {
                showToast('No hay favoritos para exportar');
                return;
            }

            showToast('üìÑ Preparando exportaci√≥n...');
            
            // Simular exportaci√≥n (aqu√≠ podr√≠as integrar jsPDF)
            setTimeout(() => {
                showToast('‚úÖ Lista de favoritos exportada exitosamente');
                
                // Crear contenido de texto simple para exportar
                let content = `MIS PROPIEDADES FAVORITAS\n\n`;
                content += `Total de propiedades: ${favoriteProperties.length}\n`;
                content += `Fecha de exportaci√≥n: ${new Date().toLocaleDateString()}\n\n`;
                
                favoriteProperties.forEach((prop, i) => {
                    content += `${i + 1}. C√ìDIGO: ${prop.codigo}\n`;
                    content += `   Precio: ${prop.allData?.C ? parseFloat(prop.allData.C).toLocaleString() + ' UF' : 'N/A'}\n`;
                    content += `   CAP RATE: ${prop.allData?.AJ ? parseFloat(prop.allData.AJ).toFixed(2) + '%' : 'N/A'}\n`;
                    content += `   Comuna: ${prop.allData?.D || 'N/A'}\n`;
                    content += `   Tipolog√≠a: ${prop.allData?.G || 'N/A'}\n\n`;
                });

                // Crear y descargar archivo
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mis-favoritos-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 1500);
        }

        
        // Funciones profesionales del comparador
        function highlightBestValues() {
            const table = document.querySelector('.compare-table');
            if (!table) return;
            
            // Limpiar highlights anteriores
            table.querySelectorAll('.best-value').forEach(cell => {
                cell.classList.remove('best-value');
            });
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach((row, rowIndex) => {
                const cells = Array.from(row.children).slice(1); // Excluir la primera columna (etiquetas)
                const rowLabel = row.children[0].textContent.toLowerCase();
                
                if (cells.length === 0) return;
                
                // Determinar si es mejor el valor m√°s alto o m√°s bajo
                const isHigherBetter = [
                    'm¬≤ interior', 'm¬≤ terraza', 'm¬≤ total', 'estacionamientos', 'bodegas', 'cap rate'
                ].some(label => rowLabel.includes(label));
                
                const isLowerBetter = [
                    'precio final uf', 'uf/m¬≤'
                ].some(label => rowLabel.includes(label));
                
                if (!isHigherBetter && !isLowerBetter) return;
                
                // Extraer valores num√©ricos
                const values = cells.map(cell => {
                    const text = cell.textContent;
                    const numMatch = text.match(/([0-9,\\.]+)/);
                    return numMatch ? parseFloat(numMatch[1].replace(/,/g, '')) : null;
                }).filter(val => val !== null);
                
                if (values.length === 0) return;
                
                const bestValue = isHigherBetter ? Math.max(...values) : Math.min(...values);
                
                // Marcar la(s) celda(s) con el mejor valor
                cells.forEach(cell => {
                    const text = cell.textContent;
                    const numMatch = text.match(/([0-9,\\.]+)/);
                    if (numMatch) {
                        const cellValue = parseFloat(numMatch[1].replace(/,/g, ''));
                        if (cellValue === bestValue) {
                            cell.classList.add('best-value');
                        }
                    }
                });
            });
            
            showToast('‚ú® Mejores valores destacados en verde');
        }
        
        function exportComparison() {
            const compareProperties = propsData.filter(prop => compareList.includes(prop.codigo));
            if (compareProperties.length === 0) {
                showToast('‚ùå No hay propiedades para exportar');
                return;
            }
            
            // Crear contenido para exportar
            let content = 'COMPARACI√ìN DE PROPIEDADES - TUMATCH INMOBILIARIO\\n\\n';
            content += `Fecha: ${new Date().toLocaleDateString('es-CL')}\\n`;
            content += `Propiedades comparadas: ${compareProperties.length}\\n\\n`;
            
            compareProperties.forEach((property, index) => {
                content += `PROPIEDAD ${index + 1}: ${property.codigo}\\n`;
                content += `Precio: ${property.precio?.toLocaleString() || 'N/D'} UF\\n`;
                content += `Tipo: ${property.allData?.I || 'N/D'}\\n`;
                content += `Comuna: ${property.allData?.D || 'N/D'}\\n`;
                content += `CAP RATE: ${property.allData?.AJ || 'N/D'}\\n`;
                content += `Bono: ${property.bono ? `$${Math.round(property.bono).toLocaleString()}` : 'Sin bono'}\\n\\n`;
            });
            
            // Crear y descargar archivo
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comparacion-propiedades-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('üì• Comparaci√≥n exportada exitosamente');
        }
        
        function calculateRecommendation() {
            const compareProperties = propsData.filter(prop => compareList.includes(prop.codigo));
            if (compareProperties.length === 0) {
                showToast('‚ùå No hay propiedades para analizar');
                return;
            }
            
            let bestProperty = null;
            let bestScore = -1;
            let analysis = {};
            
            compareProperties.forEach(property => {
                let score = 0;
                let reasons = [];
                
                // CAP RATE (peso: 30%)
                const capRate = property.allData?.AJ ? parseFloat(property.allData.AJ) : 0;
                if (capRate > 4) { score += 30; reasons.push(`Excelente CAP RATE (${capRate}%)`); }
                else if (capRate > 2) { score += 15; reasons.push(`CAP RATE aceptable (${capRate}%)`); }
                
                // Precio/m¬≤ (peso: 25%)
                const ufM2 = property.allData?.AF ? parseFloat(property.allData.AF) : Infinity;
                if (ufM2 < 50) { score += 25; reasons.push('Precio por m¬≤ muy competitivo'); }
                else if (ufM2 < 80) { score += 15; reasons.push('Precio por m¬≤ razonable'); }
                
                // Bono (peso: 20%)
                if (property.bono > 5000000) { score += 20; reasons.push('Bono muy atractivo'); }
                else if (property.bono > 2000000) { score += 10; reasons.push('Bono interesante'); }
                
                // Estacionamientos y bodegas (peso: 15%)
                const est = parseInt(property.allData?.J || 0);
                const bod = parseInt(property.allData?.K || 0);
                if (est >= 2) { score += 8; reasons.push('M√∫ltiples estacionamientos'); }
                if (bod >= 1) { score += 7; reasons.push('Incluye bodega'); }
                
                // Tama√±o (peso: 10%)
                const m2 = property.allData?.L ? parseFloat(property.allData.L) : 0;
                if (m2 > 80) { score += 10; reasons.push('Amplio metraje'); }
                else if (m2 > 50) { score += 5; reasons.push('Buen tama√±o'); }
                
                analysis[property.codigo] = { score, reasons };
                
                if (score > bestScore) {
                    bestScore = score;
                    bestProperty = property;
                }
            });
            
            // Mostrar recomendaci√≥n
            let recommendationHtml = `
                <div style=\"background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1)); 
                            border: 2px solid rgba(34, 197, 94, 0.3); 
                            border-radius: 20px; 
                            padding: 30px; 
                            margin-top: 30px;\">
                    <h3 style=\"color: #22c55e; margin-bottom: 20px; text-align: center;\">
                        üß† RECOMENDACI√ìN INTELIGENTE
                    </h3>
            `;
            
            if (bestProperty) {
                recommendationHtml += `
                    <div style=\"text-align: center; margin-bottom: 20px;\">
                        <h4 style=\"color: #22c55e; font-size: 1.3rem;\">
                            üèÜ MEJOR OPCI√ìN: ${bestProperty.codigo}
                        </h4>
                        <p style=\"color: white; font-size: 1.1rem;\">
                            Puntuaci√≥n: ${bestScore}/100 puntos
                        </p>
                    </div>
                    <div style=\"margin-bottom: 20px;\">
                        <strong style=\"color: #22c55e;\">Razones:</strong>
                        <ul style=\"margin-top: 10px; color: white;\">
                `;
                
                analysis[bestProperty.codigo].reasons.forEach(reason => {
                    recommendationHtml += `<li>‚úì ${reason}</li>`;
                });
                
                recommendationHtml += '</ul></div>';
            }
            
            recommendationHtml += `
                    <div style=\"border-top: 1px solid rgba(34, 197, 94, 0.3); padding-top: 20px;\">
                        <h5 style=\"color: #22c55e; margin-bottom: 15px;\">üìä An√°lisis Completo:</h5>
            `;
            
            compareProperties.sort((a, b) => analysis[b.codigo].score - analysis[a.codigo].score).forEach((property, index) => {
                const propertyAnalysis = analysis[property.codigo];
                recommendationHtml += `
                    <div style=\"margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;\">
                        <strong>${index + 1}. ${property.codigo}</strong> - ${propertyAnalysis.score} puntos
                        <div style=\"font-size: 0.9rem; margin-top: 5px; opacity: 0.9;\">
                            ${propertyAnalysis.reasons.join(' | ')}
                        </div>
                    </div>
                `;
            });
            
            recommendationHtml += `
                    </div>
                </div>
            `;
            
            document.getElementById('compare-content').innerHTML += recommendationHtml;
            showToast('üß† Recomendaci√≥n inteligente generada');
        }
        
        function clearAllComparisons() {
            showConfirmModal(
                'üóëÔ∏è Limpiar Comparaci√≥n',
                '¬øEst√°s seguro de que deseas eliminar todas las propiedades de la comparaci√≥n?',
                'Esta acci√≥n no se puede deshacer.',
                () => {
                    // Confirmado
                    compareList = [];
                    localStorage.setItem('propertyCompare', JSON.stringify(compareList));
                    updateCompareCounter();
                    updateCompareButtons();
                    
                    // EN LOCAL: Simular F5 refrescando todo el estado
                    showingCompare = false;
                    showingFavorites = false;
                    
                    // Ocultar todas las vistas
                    document.getElementById('compare-content').style.display = 'none';
                    document.getElementById('favorites-content').style.display = 'none';
                    document.getElementById('compareSection').classList.remove('active');
                    document.getElementById('favoritesSection').classList.remove('active');
                    
                    // Mostrar vista principal
                    document.querySelector('.properties-section').style.display = 'block';
                    document.querySelector('.filters-section').style.display = 'block';
                    document.getElementById('property-list').style.display = 'grid';
                    
                    // Actualizar botones
                    document.getElementById('toggleCompareBtn').innerHTML = `üîÑ Comparar (<span id="compareCount">0</span>)`;
                    
                    showToast('üóëÔ∏è Comparaci√≥n limpiada');
                }
            );
        }

        function showAlert(title, message, type = 'info') {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(8px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease-in-out;
            `;

            // Determinar color e icono seg√∫n el tipo
            let bgColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1))';
                    icon = '‚úÖ';
                    break;
                case 'warning':
                    bgColor = 'linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1))';
                    icon = '‚ö†Ô∏è';
                    break;
                case 'error':
                    bgColor = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1))';
                    icon = '‚ùå';
                    break;
                default:
                    bgColor = 'linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 85, 255, 0.1))';
                    icon = '‚ÑπÔ∏è';
            }

            modal.innerHTML = `
                <div style="
                    background: ${bgColor};
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 450px;
                    width: 90%;
                    text-align: center;
                    color: white;
                    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.3s ease-out;
                ">
                    <div style="font-size: 3rem; margin-bottom: 20px;">${icon}</div>
                    <h3 style="
                        font-size: 1.4rem;
                        margin-bottom: 15px;
                        color: white;
                        font-weight: 600;
                    ">${title}</h3>
                    
                    <p style="
                        font-size: 1rem;
                        margin-bottom: 30px;
                        line-height: 1.4;
                        opacity: 0.9;
                    ">${message}</p>
                    
                    <button id="okBtn" style="
                        background: linear-gradient(135deg, #8A2BE2, #4B55FF);
                        border: none;
                        color: white;
                        padding: 12px 30px;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">Entendido</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listener
            modal.querySelector('#okBtn').onclick = () => {
                modal.style.animation = 'fadeOut 0.2s ease-in-out';
                setTimeout(() => document.body.removeChild(modal), 200);
            };

            // Cerrar al hacer clic fuera
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.animation = 'fadeOut 0.2s ease-in-out';
                    setTimeout(() => document.body.removeChild(modal), 200);
                }
            };
        }

        function showConfirmModal(title, message, subtitle, onConfirm) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(8px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease-in-out;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 85, 255, 0.1));
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 450px;
                    width: 90%;
                    text-align: center;
                    color: white;
                    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.3s ease-out;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        margin-bottom: 20px;
                        color: #8A2BE2;
                        font-weight: 600;
                    ">${title}</h3>
                    
                    <p style="
                        font-size: 1.1rem;
                        margin-bottom: 10px;
                        line-height: 1.4;
                    ">${message}</p>
                    
                    <p style="
                        font-size: 0.9rem;
                        opacity: 0.7;
                        margin-bottom: 30px;
                    ">${subtitle}</p>
                    
                    <div style="
                        display: flex;
                        gap: 15px;
                        justify-content: center;
                    ">
                        <button id="cancelBtn" style="
                            background: rgba(255, 255, 255, 0.1);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 12px 25px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 1rem;
                            transition: all 0.3s ease;
                        ">Cancelar</button>
                        
                        <button id="confirmBtn" style="
                            background: linear-gradient(135deg, #ef4444, #dc2626);
                            border: none;
                            color: white;
                            padding: 12px 25px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            transition: all 0.3s ease;
                        ">Confirmar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            modal.querySelector('#cancelBtn').onclick = () => {
                modal.style.animation = 'fadeOut 0.2s ease-in-out';
                setTimeout(() => document.body.removeChild(modal), 200);
            };

            modal.querySelector('#confirmBtn').onclick = () => {
                modal.style.animation = 'fadeOut 0.2s ease-in-out';
                setTimeout(() => {
                    document.body.removeChild(modal);
                    onConfirm();
                }, 200);
            };

            // Cerrar al hacer clic fuera
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.animation = 'fadeOut 0.2s ease-in-out';
                    setTimeout(() => document.body.removeChild(modal), 200);
                }
            };
        }
        
        // Funci√≥n para volver arriba
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Mostrar/ocultar bot√≥n de volver arriba
        window.addEventListener('scroll', () => {
            const scrollButton = document.getElementById('scrollToTop');
            if (window.scrollY > 300) {
                scrollButton.classList.add('visible');
            } else {
                scrollButton.classList.remove('visible');
            }
        });

        // Toast notifications profesionales
        window.addEventListener('show-toast', (e) => {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                background: linear-gradient(135deg, rgba(138, 43, 226, 0.95), rgba(75, 85, 255, 0.9));
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 20px 30px;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(138, 43, 226, 0.3);
                z-index: 10001;
                font-weight: 500;
                font-size: 1rem;
                max-width: 350px;
                animation: slideInToast 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            // Determinar icono seg√∫n el tipo de mensaje
            let icon = '‚ú®';
            if (e.detail.message.includes('quitada') || e.detail.message.includes('eliminada')) {
                icon = 'üóëÔ∏è';
            } else if (e.detail.message.includes('agregada') || e.detail.message.includes('guardada')) {
                icon = '‚úÖ';
            } else if (e.detail.message.includes('M√°ximo') || e.detail.message.includes('Error')) {
                icon = '‚ö†Ô∏è';
            } else if (e.detail.message.includes('exportada')) {
                icon = 'üì•';
            } else if (e.detail.message.includes('limpiada')) {
                icon = 'üßπ';
            } else if (e.detail.message.includes('Recomendaci√≥n')) {
                icon = 'üß†';
            }
            
            toast.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${e.detail.message}</span>`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutToast 0.4s cubic-bezier(0.16, 1, 0.3, 1)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        });
    </script>
    
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slideInToast {
            from { 
                transform: translateX(100%) translateY(-20px);
                opacity: 0;
                scale: 0.9;
            }
            to { 
                transform: translateX(0) translateY(0);
                opacity: 1;
                scale: 1;
            }
        }

        @keyframes slideOutToast {
            from { 
                transform: translateX(0) translateY(0);
                opacity: 1;
                scale: 1;
            }
            to { 
                transform: translateX(100%) translateY(-20px);
                opacity: 0;
                scale: 0.9;
            }
        }
    </style>
</body>
</html>